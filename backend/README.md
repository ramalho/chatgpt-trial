# chatgpt-trial
Exploring ChatGPT to see how it help developer. As a new dotnet developers, how does ChatGPT help us.

We created a c# webapi project step by step, eventually, we implemented a repository layer by entity framework, created a service layer, and inject some business requirements, finally, we render the data by API. besides that, we ask ChatGPT to generate all the unit tests for each layer.

##
Here are all the steps I interacted with ChatGPT, the items are the commands I sent to ChatGPT:
1. create api project by dotnet cli
```bash
dotnet new webapi -n [project name]
```
2. create dotnet solution by dotnet cli
```bash
dotnet sln [solution name].sln add [project name]/[project name].csproj
```
3. how to ignore .idea/ folder in git
```bash
.idea/
```
4. what's the popular log library for dotnet core
   - Another popular logging library for .NET Core is NLog...
5. how can I apply nlog in my dotnet core 6.0 api project
   - The answer is not very accuracy, I have to go to official website to get the steps
6. generate docker file for my dotnet 6 api project with docker multistage build support 
    - the base image is wrong, see the script in Dockerfile1
    -  Finally the Dockerfile script was generated by rider build-in feature
       - docker build -f ./School.Api/Dockerfile -t school.api:v1 .
       - docker run -it -p 80:80 school.api:v1
       - http://localhost/WeatherForecast
7. Generate a c# class for Student model with ID, last name, first name, enrollment date, email, age and a collection of enrollments
```csharp
public class Student
{
    public int ID { get; set; }
    public string LastName { get; set; }
    public string FirstName { get; set; }
    public DateTime EnrollmentDate { get; set; }
    public string Email { get; set; }
    public int Age { get; set; }
    public ICollection<Enrollment> Enrollments { get; set; }
}
```
8. Generate c# class for Enrollment with EnrollmentID, CourseID, StudentID
```csharp
public class Enrollment
{
    public int EnrollmentID { get; set; }
    public int CourseID { get; set; }
    public int StudentID { get; set; }
}
```
9. what's best way to connect sql server in c# webapi application
  - EF
  - Dapper
10. how to use entity framework in my c# web api project 
  - SchoolDbContext
  - Install Microsoft.EntityFrameworkCore

11. How can I connect to my sql sever by entity framework

12. How can I start ms sql server in docker
```bash
docker run -e "ACCEPT_EULA=Y" -e "SA_PASSWORD=Password1" -p 1433:1433 --name sql1 -d mcr.microsoft.com/mssql/server:latest
```
13. Start up a postgresql container in mac m1
 ```bash
docker run -p 5432:5432 -e POSTGRES_USER=admin -e POSTGRES_PASSWORD=Password1 -e POSTGRES_DB=School --name database -d postgres 
```
14. create docker compose file for spin up a postgresql
15. what's the user name and database name

14. connect postgresql by entity framework in my project
   - Npgsql.EntityFrameworkCore.PostgreSQL
15. write a unit test to test my entity framework connectivity
```csharp
[TestClass]
public class MyDbContextTests
{
    [TestMethod]
    public void Test_Connection()
    {
        // Arrange
        var options = new DbContextOptionsBuilder<MyDbContext>()
            .UseNpgsql("Host=localhost;Port=5432;Database=mydb;Username=myuser;Password=mypassword;")
            .Options;

        // Act
        using (var context = new MyDbContext(options))
        {
            // Assert
            Assert.IsNotNull(context);
            Assert.IsInstanceOfType(context, typeof(MyDbContext));
        }
    }
}
```
16. please correct above test by xunit
17. please generate SchoolRepository with above model by entity framework
17. write unit test for SchoolRepository
```csharp
public class SchoolRepositoryTests
{
    private readonly SchoolRepository _repository;

    public SchoolRepositoryTests()
    {
        var options = new DbContextOptionsBuilder<SchoolContext>()
            .UseInMemoryDatabase(Guid.NewGuid().ToString())
            .Options;

        var context = new SchoolContext(options);
        _repository = new SchoolRepository(context);
    }

    [Fact]
    public void Test_GetAllStudents()
    {
        // Arrange
        var expected = new List<Student>
        {
            new Student { Id = 1, LastName = "Doe", FirstName = "John", EnrollmentDate=DateTime.Now,Email="john@example.com",Age=20 },
            new Student { Id = 2, LastName = "Smith", FirstName = "Jane", EnrollmentDate=DateTime.Now,Email="jane@example.com",Age=22 },
            new Student { Id = 3, LastName = "Williams", FirstName = "Mark", EnrollmentDate=DateTime.Now,Email="mark@example.com",Age=21 }
        };

        context.Students.AddRange(expected);
        context.SaveChanges();

        // Act
        var actual = _repository.GetAllStudents();

        // Assert
        Assert.Equal(expected.Count, actual.Count());
        Assert.Equal(expected, actual, new StudentComparer());
    }

    [Fact]
    public void Test_GetStudentById()
    {
        // Arrange
        var expected = new Student { Id = 1, LastName = "Doe", FirstName = "John", EnrollmentDate=DateTime.Now,Email="john@example.com",Age=20 };
        context.Students.Add(expected);
        context.SaveChanges();

        // Act
        var actual = _repository.GetStudentById(expected.Id);

        // Assert
        Assert.Equal(expected, actual, new StudentComparer());
    }

    [Fact]
    public void Test_AddStudent()
    {
        // Arrange
        var student = new Student { LastName = "Johnson", FirstName = "Bob", EnrollmentDate=DateTime.Now,Email="bob@example.com",Age=23 };

    } 

```
18. please generate above unit tests by renaming MyDbContext to SchoolContext
19. what's UseInMemoryDatabase in above code, compiler can't recognize it
```ybase
Microsoft.EntityFrameworkCore.InMemory
```
20. test Test_AddStudent didn't generated complete
```csharp
[Fact]
public void Test_AddStudent()
{
    // Arrange
    var student = new Student { LastName = "Johnson", FirstName = "Bob", EnrollmentDate = new DateTime(2022,1,1), Email = "bobjohnson@test.com", Age = 25 };

    // Act
    _repository.AddStudent(student);

    // Assert
    Assert.Contains(student, _repository.GetAllStudents(), new StudentComparer());
}
```
21. generate method for GetStudentEnrollments in StudentRepository
22. please create a controller based on my StudentRepository
23. please create some unit tests for my controller
24. what's Should() in the tests, my compiler got an error
> The Should() method is an extension method from the FluentAssertions library, which is a popular library for writing more readable and expressive assertions in unit tests. It allows you to write assertions in a fluent, natural language-like syntax.

25. please create a yaml file for deployment my webapi application to kubernetes

## An interactive example to ask ChatGPT to refactor code
- Q: Give a c# method in below, please write a unit test for it
```csharp
public async Task<List<Student?>> GetStudents()
{
    return await context.Students.ToListAsync();
}
```
- A: Here is an code snippet
```csharp
[Fact]
public async Task GetStudents_ReturnsListOfStudents()
{
    // Arrange
    var options = new DbContextOptionsBuilder<MyDbContext>()
        .UseInMemoryDatabase(databaseName: "GetStudents_ReturnsListOfStudents")
        .Options;

    // Insert seed data into the in-memory database
    using (var context = new MyDbContext(options))
    {
        context.Students.Add(new Student { Id = 1, Name = "John Doe" });
        context.Students.Add(new Student { Id = 2, Name = "Jane Doe" });
        context.SaveChanges();
    }

    // Act
    using (var context = new MyDbContext(options))
    {
        var service = new StudentService(context);
        var students = await service.GetStudents();

        // Assert
        Assert.Equal(2, students.Count);
        Assert.Equal("John Doe", students[0].Name);
        Assert.Equal("Jane Doe", students[1].Name);
    }
}

```
- Q: you created the instance of the MyDbContext twice in above test, can we write a class for this test and move some code into constructor?
- A: 
```csharp
public class StudentServiceTests
{
    private readonly MyDbContext _context;
    private readonly StudentService _service;

    public StudentServiceTests()
    {
        var options = new DbContextOptionsBuilder<MyDbContext

```
- Q: it's not StudentServiceTests, it's StudentRepositoryTests
- A: 
```csharp
public class StudentRepositoryTests
{
    private readonly MyDbContext _context;
    private readonly StudentRepository _repository;

    public StudentRepositoryTests()
    {
        var options = new DbContextOptionsBuilder<MyDbContext>()
            .UseInMemoryDatabase(databaseName: "GetStudents_ReturnsListOfStudents")
            .Options;
        _context = new MyDbContext(options);
        _repository = new StudentRepository(_context);
        _context.Students.Add(new Student { Id = 1, Name = "John Doe" });
        _context.Students.Add(new Student { Id = 2, Name = "Jane Doe" });
        _context.SaveChanges();
    }

    [Fact]
    public async Task GetStudents_ReturnsListOfStudents()
    {
        // Act
        var students = await _repository.GetStudents();

        // Assert
        Assert.Equal(2, students.Count);
        Assert.Equal("John Doe", students[0].Name);
        Assert.Equal("Jane Doe", students[1].Name);
    }
}
```
- Q: Student model has Id, last name, first name, enrollment date, email, age and a collection of enrollments
please include all the properties when you are creating student instance
- A: 
```csharp
public class StudentRepositoryTests
{
    private readonly MyDbContext _context;
    private readonly StudentRepository _repository;

    public StudentRepositoryTests()
    {
        var options = new DbContextOptionsBuilder<MyDbContext>()
            .UseInMemoryDatabase(databaseName: "GetStudents_ReturnsListOfStudents")
            .Options;
        _context = new MyDbContext(options);
        _repository = new StudentRepository(_context);
        _context.Students.Add(new Student 
        { 
            Id = 1, 
            FirstName = "John", 
            LastName = "Doe", 
            EnrollmentDate = DateTime.Now, 
            Email = "john.doe@email.com", 
            Age = 21, 
            Enrollments = new List<Enrollment>() 
        });
        _context.Students.Add(new Student 
        { 
            Id = 2, 
            FirstName = "Jane", 
            LastName = "Doe", 
            EnrollmentDate = DateTime.Now, 
            Email = "jane.doe@email.com", 
            Age = 22, 
            Enrollments = new List<Enrollment>()
        });
        _context.SaveChanges();

```

## An interactive example to implement business with ChatGPT
- Q: Here is my StudentRepository, please create StudentService class for me so I can inject some business logic in StudentService
- A: 
```csharp
public class StudentService
{
    private readonly StudentRepository _studentRepository;

    public StudentService(StudentRepository studentRepository)
    {
        _studentRepository = studentRepository;
    }

    public async Task<List<Student>> GetAllStudents()
    {
        return await _studentRepository.GetStudents();
    }

    public async Task<Student?> GetStudentById(int id)
    {
        return await _studentRepository.GetStudentById(id);
    }

    public async Task<ICollection<Enrollment>?> GetStudentEnrollments(int studentId)
    {
        return await _studentRepository.GetStudentEnrollmentsAsync(studentId);
    }

    public async Task InsertStudent(Student student)
    {
        if (student.Age < 18)
        {
            throw new Exception("Age should be greater than 18");
        }
        await _studentRepository.InsertStudent(student);
    }

    public async Task DeleteStudent(int studentId)
    {
        await _studentRepository.DeleteStudent(studentId);
    }
}
```
- Q: let's talk about GetStudentById method, there are below acceptance criteria:
1. when Id great than 100 should throw an InvalidStudentIdException
2. when Id equal than 0 should throw an InvalidStudentIdException
   Please implement this logic in StudentService class
- A: 
```csharp
    public async Task<Student?> GetStudentById(int id)
    {
        if (id <= 0)
        {
            throw new InvalidStudentIdException("Id should be greater than 0");
        }
        if (id > 100)
        {
            throw new InvalidStudentIdException("Id should be less than or equal to 100");
        }
        return await _studentRepository.GetStudentById(id);
    }
```
- A: Let's talk about InsertStudent method, there are below acceptance criteria:
1. When First name is "Test", then assign Last name to "Hello"
2. Email should be a valid email format
3. Age must great than 0
   Please implement these business into StudentService class
- Q: 
```csharp
public async Task InsertStudent(Student student)
    {
        if (student.FirstName == "Test")
        {
            student.LastName = "Hello";
        }
        if (student.Age <= 0)
        {
            throw new Exception("Age should be greater than 0");
        }
        if (!IsValidEmail(student.Email))
        {
            throw new Exception("Invalid email format");
        }

        await _studentRepository.InsertStudent(student);
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var addr = new System.Net.Mail.MailAddress(email);
            return addr.Address == email;
        }
        catch
        {
            return false;
        }
    }
```

- Q: please write unit tests for InsertStudent method
- A: Unit tests were generated correctly 


## Conclusion
### The following features enable ChatGPT to act as an efficient pair to help up write code 

1. You can continuously interact with ChatGPT surrounding the same topic and ChatGPT has the ability to improve the answer
2. ChatGPT could understand the code and your instruction, you can talk with ChatGPT for refactoring code
3. ChatGPT could understand the business, which means you can input the business requirement as much as possible and ask ChatGPT to generate the code

### Downsides 

1. The connection is not very stable, sometimes the connection is closed and you need to reload the whole conversation
2. Some answers are inaccurate(Generate dockerfile/integrate with nlog library), it probably because ChatGPT was trained by Limited knowledge of world and events after 2021
3. Even if ChatGPT is more clever than google/StackOverflow, it still is not able to replace the person who pairs with you, because, unlike the person who could give some design suggestions, ChatGPT works passively, you need to drive the direction, continuously by asking practical questions.
